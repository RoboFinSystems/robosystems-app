#!/bin/bash
# =============================================================================
# ROBOSYSTEMS APP GITHUB REPOSITORY SETUP SCRIPT
# =============================================================================
#
# This script configures GitHub repository secrets and variables used by CI/CD
# pipelines and deployment automation for the RoboSystems App frontend.
#
# Usage:
#   npm run setup:gha
#   or directly: ./bin/gha-setup
#
# Required GitHub repository configuration:
# - Repository secrets (sensitive data)
# - Repository variables (non-sensitive configuration)
#
# =============================================================================

set -euo pipefail

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# Function to print colored output
print_error() {
    echo -e "${RED}‚ùå $1${NC}" >&2
}

print_info() {
    echo -e "${BLUE}‚ÑπÔ∏è  $1${NC}"
}

print_success() {
    echo -e "${GREEN}‚úÖ $1${NC}"
}

print_warning() {
    echo -e "${YELLOW}‚ö†Ô∏è  $1${NC}"
}

echo "=== RoboSystems App GitHub Repository Setup ==="
echo ""

# =============================================================================
# GITHUB SETUP FUNCTIONS
# =============================================================================

function check_prerequisites() {
    print_info "Checking prerequisites..."

    # Check GitHub CLI
    if ! command -v gh >/dev/null 2>&1; then
        print_error "GitHub CLI is not installed. Please install it first."
        echo "   Visit: https://cli.github.com/"
        exit 1
    fi

    # Check GitHub authentication
    if ! gh auth status >/dev/null 2>&1; then
        print_error "GitHub CLI not authenticated."
        echo "   Run: gh auth login"
        exit 1
    fi

    # Check if we're in a git repository
    if ! git rev-parse --is-inside-work-tree >/dev/null 2>&1; then
        print_error "Not in a git repository"
        exit 1
    fi

    # Get repository name
    REPO_NAME=$(gh repo view --json nameWithOwner -q .nameWithOwner 2>/dev/null || echo "")
    if [ -z "$REPO_NAME" ]; then
        print_error "Could not determine repository name"
        exit 1
    fi

    print_success "Prerequisites check passed"
    print_info "Repository: $REPO_NAME"
    echo ""
}

function setup_secrets() {
    echo "Setting up GitHub repository secrets..."
    echo ""
    echo "‚ö†Ô∏è  Many secrets may be set at the ORGANIZATION level and inherited."
    echo "    Check existing secrets first: gh secret list"
    echo ""
    echo "üìã With OIDC authentication, AWS credentials are NOT needed!"
    echo "   Workflows authenticate via AWS_ROLE_ARN (set by bootstrap)"
    echo ""
    echo "üìã OPTIONAL secrets (enable additional features):"
    echo ""
    echo "# Enables workflow automations (deploy after release, gh CLI in workflows)"
    echo "gh secret set ACTIONS_TOKEN --body \"your_github_personal_access_token\""
    echo ""
    echo "# Enables Claude-powered PR/release workflows"
    echo "gh secret set ANTHROPIC_API_KEY --body \"your_anthropic_api_key\""
    echo ""
    echo "üí° ACTIONS_TOKEN needs these permissions:"
    echo "   - repo (full control)"
    echo "   - workflow (update workflows)"
    echo ""
    echo "Secrets information completed!"
}

function setup_minimum_config() {
    echo "Setting up minimal configuration..."
    echo "üí° Only essential variables required - everything else has sensible defaults!"
    echo ""

    # Check for existing AWS Account ID
    EXISTING_AWS_ID=$(gh variable get AWS_ACCOUNT_ID 2>/dev/null || echo "")

    # Absolutely essential variables
    echo "üìã Required variables:"

    if [ -n "$EXISTING_AWS_ID" ]; then
        echo "  AWS Account ID already set: $EXISTING_AWS_ID"
        read -p "  Press Enter to keep, or enter new value: " AWS_ACCOUNT_ID
        AWS_ACCOUNT_ID=${AWS_ACCOUNT_ID:-$EXISTING_AWS_ID}
    else
        read -p "Enter AWS Account ID: " AWS_ACCOUNT_ID
    fi

    read -p "Enter Domain Name (e.g., robosystems.ai): " DOMAIN_NAME

    echo ""
    echo "üîß Optional variables (press Enter to use defaults):"
    read -p "Repository Name [RoboFinSystems/robosystems-app]: " REPOSITORY_NAME
    REPOSITORY_NAME=${REPOSITORY_NAME:-"RoboFinSystems/robosystems-app"}
    read -p "ECR Repository Name [robosystems-app]: " ECR_REPOSITORY
    ECR_REPOSITORY=${ECR_REPOSITORY:-"robosystems-app"}
    read -p "AWS Region [us-east-1]: " AWS_REGION
    AWS_REGION=${AWS_REGION:-"us-east-1"}

    echo ""
    echo "üåê Related App URLs (for SSO navigation):"
    read -p "RoboSystems API URL [https://api.robosystems.ai]: " API_URL
    API_URL=${API_URL:-"https://api.robosystems.ai"}
    read -p "RoboLedger App URL [https://roboledger.ai]: " ROBOLEDGER_URL
    ROBOLEDGER_URL=${ROBOLEDGER_URL:-"https://roboledger.ai"}
    read -p "RoboInvestor App URL [https://roboinvestor.ai]: " ROBOINVESTOR_URL
    ROBOINVESTOR_URL=${ROBOINVESTOR_URL:-"https://roboinvestor.ai"}

    # Set the essential variables
    echo ""
    echo "Setting variables..."

    # Core Infrastructure
    gh variable set REPOSITORY_NAME --body "$REPOSITORY_NAME"
    gh variable set AWS_ACCOUNT_ID --body "$AWS_ACCOUNT_ID"
    gh variable set AWS_REGION --body "$AWS_REGION"
    gh variable set ECR_REPOSITORY --body "$ECR_REPOSITORY"

    # Environment Configuration
    gh variable set ENVIRONMENT_PROD --body "prod"
    gh variable set ENVIRONMENT_STAGING --body "staging"
    gh variable set ENVIRONMENT_STAGING_ENABLED --body "false"

    # Domain Configuration
    gh variable set DOMAIN_NAME_ROOT --body "$DOMAIN_NAME"
    gh variable set DOMAIN_NAME_PROD --body "$DOMAIN_NAME"  # Main domain without www
    gh variable set DOMAIN_NAME_STAGING --body "staging.$DOMAIN_NAME"

    # App URLs for SSO
    gh variable set ROBOSYSTEMS_API_URL_PROD --body "$API_URL"
    gh variable set ROBOSYSTEMS_API_URL_STAGING --body "https://staging.api.$DOMAIN_NAME"
    gh variable set ROBOSYSTEMS_APP_URL_PROD --body "https://$DOMAIN_NAME"
    gh variable set ROBOSYSTEMS_APP_URL_STAGING --body "https://staging.$DOMAIN_NAME"
    gh variable set ROBOLEDGER_APP_URL_PROD --body "$ROBOLEDGER_URL"
    gh variable set ROBOLEDGER_APP_URL_STAGING --body "https://staging.roboledger.ai"
    gh variable set ROBOINVESTOR_APP_URL_PROD --body "$ROBOINVESTOR_URL"
    gh variable set ROBOINVESTOR_APP_URL_STAGING --body "https://staging.roboinvestor.ai"

    # ECS Service Configuration - Production
    gh variable set CAPACITY_MIN_PROD --body "1"
    gh variable set CAPACITY_MAX_PROD --body "10"
    gh variable set CPU_PROD --body "256"
    gh variable set MEMORY_PROD --body "512"
    gh variable set SCALE_UP_CPU_THRESHOLD_PROD --body "70"
    gh variable set SCALE_DOWN_CPU_THRESHOLD_PROD --body "30"
    gh variable set SCALE_UP_MEMORY_THRESHOLD_PROD --body "65"
    gh variable set SCALE_DOWN_MEMORY_THRESHOLD_PROD --body "25"
    gh variable set FARGATE_SPOT_WEIGHT_PROD --body "80"
    gh variable set FARGATE_WEIGHT_PROD --body "20"

    # ECS Service Configuration - Staging
    gh variable set CAPACITY_MIN_STAGING --body "1"
    gh variable set CAPACITY_MAX_STAGING --body "2"
    gh variable set CPU_STAGING --body "256"
    gh variable set MEMORY_STAGING --body "512"
    gh variable set SCALE_UP_CPU_THRESHOLD_STAGING --body "60"
    gh variable set SCALE_DOWN_CPU_THRESHOLD_STAGING --body "40"
    gh variable set SCALE_UP_MEMORY_THRESHOLD_STAGING --body "60"
    gh variable set SCALE_DOWN_MEMORY_THRESHOLD_STAGING --body "30"
    gh variable set FARGATE_SPOT_WEIGHT_STAGING --body "99"
    gh variable set FARGATE_WEIGHT_STAGING --body "1"

    # Release Configuration
    gh variable set RELEASE_NAME --body "GitHub Actions"
    gh variable set RELEASE_EMAIL --body "actions@github.com"

    # Feature Flags (optional)
    gh variable set MAINTENANCE_MODE_PROD --body "false"
    gh variable set MAINTENANCE_MODE_STAGING --body "false"
    # TURNSTILE_SITE_KEY is optional - only set if provided
    # gh variable set TURNSTILE_SITE_KEY --body "your_turnstile_site_key"

    # SNS Alert Email (optional)
    gh variable set AWS_SNS_ALERT_EMAIL --body ""

    # DockerHub Configuration (optional)
    gh variable set DOCKERHUB_USERNAME --body ""

    echo ""
    echo "‚úÖ Minimal configuration completed!"
    echo ""
    echo "üìã Variables set:"
    echo "  üåê Domain: $DOMAIN_NAME"
    echo "  üì¶ Repository: $REPOSITORY_NAME"
    echo "  üîë AWS Account: $AWS_ACCOUNT_ID"
    echo "  üê≥ ECR Repository: $ECR_REPOSITORY"
    echo "  üìç Region: $AWS_REGION"
    echo ""
    echo "üöÄ Your deployment is ready to run!"
    echo "üí° All settings use cost-optimized defaults."
    echo ""
    echo "üìã Next steps:"
    echo "1. Run bootstrap first if not done: ./bin/bootstrap"
    echo "   (Sets AWS_ROLE_ARN for OIDC authentication)"
    echo "2. Optional secrets for additional features: gh secret list"
    echo "   - ACTIONS_TOKEN (workflow automations)"
    echo "   - ANTHROPIC_API_KEY (Claude PR/release workflows)"
    echo "3. Test with: gh workflow run prod.yml"
}

function setup_full_config() {
    echo "Setting up full configuration with all variables..."
    echo ""

    # Get user input for key variables
    read -p "Enter Domain Name (e.g., robosystems.ai): " DOMAIN_NAME
    read -p "Enter AWS Account ID: " AWS_ACCOUNT_ID
    read -p "Enter Repository Name [RoboFinSystems/robosystems-app]: " REPOSITORY_NAME
    REPOSITORY_NAME=${REPOSITORY_NAME:-"RoboFinSystems/robosystems-app"}
    read -p "Enter ECR Repository Name [robosystems-app]: " ECR_REPOSITORY
    ECR_REPOSITORY=${ECR_REPOSITORY:-"robosystems-app"}
    read -p "Enter AWS Region [us-east-1]: " AWS_REGION
    AWS_REGION=${AWS_REGION:-"us-east-1"}

    echo ""
    echo "Setting all variables..."

    # Core Infrastructure
    gh variable set REPOSITORY_NAME --body "$REPOSITORY_NAME"
    gh variable set AWS_ACCOUNT_ID --body "$AWS_ACCOUNT_ID"
    gh variable set AWS_REGION --body "$AWS_REGION"
    gh variable set ECR_REPOSITORY --body "$ECR_REPOSITORY"

    # Environment Configuration
    gh variable set ENVIRONMENT_PROD --body "prod"
    gh variable set ENVIRONMENT_STAGING --body "staging"
    gh variable set ENVIRONMENT_STAGING_ENABLED --body "false"

    # Domain Configuration
    gh variable set DOMAIN_NAME_ROOT --body "$DOMAIN_NAME"
    gh variable set DOMAIN_NAME_PROD --body "$DOMAIN_NAME"  # Main domain without www
    gh variable set DOMAIN_NAME_STAGING --body "staging.$DOMAIN_NAME"

    # App URLs for SSO and API Integration
    echo ""
    read -p "RoboSystems API URL [https://api.robosystems.ai]: " API_URL
    API_URL=${API_URL:-"https://api.robosystems.ai"}
    read -p "RoboLedger App URL [https://roboledger.ai]: " ROBOLEDGER_URL
    ROBOLEDGER_URL=${ROBOLEDGER_URL:-"https://roboledger.ai"}
    read -p "RoboInvestor App URL [https://roboinvestor.ai]: " ROBOINVESTOR_URL
    ROBOINVESTOR_URL=${ROBOINVESTOR_URL:-"https://roboinvestor.ai"}

    gh variable set ROBOSYSTEMS_API_URL_PROD --body "$API_URL"
    gh variable set ROBOSYSTEMS_API_URL_STAGING --body "https://staging.api.$DOMAIN_NAME"
    gh variable set ROBOSYSTEMS_APP_URL_PROD --body "https://$DOMAIN_NAME"
    gh variable set ROBOSYSTEMS_APP_URL_STAGING --body "https://staging.$DOMAIN_NAME"
    gh variable set ROBOLEDGER_APP_URL_PROD --body "$ROBOLEDGER_URL"
    gh variable set ROBOLEDGER_APP_URL_STAGING --body "https://staging.roboledger.ai"
    gh variable set ROBOINVESTOR_APP_URL_PROD --body "$ROBOINVESTOR_URL"
    gh variable set ROBOINVESTOR_APP_URL_STAGING --body "https://staging.roboinvestor.ai"

    # ECS Service Configuration - Production
    echo ""
    read -p "Production min capacity [1]: " MIN_PROD
    MIN_PROD=${MIN_PROD:-"1"}
    read -p "Production max capacity [10]: " MAX_PROD
    MAX_PROD=${MAX_PROD:-"10"}

    gh variable set CAPACITY_MIN_PROD --body "$MIN_PROD"
    gh variable set CAPACITY_MAX_PROD --body "$MAX_PROD"
    gh variable set CPU_PROD --body "256"
    gh variable set MEMORY_PROD --body "512"
    gh variable set SCALE_UP_CPU_THRESHOLD_PROD --body "70"
    gh variable set SCALE_DOWN_CPU_THRESHOLD_PROD --body "30"
    gh variable set SCALE_UP_MEMORY_THRESHOLD_PROD --body "65"
    gh variable set SCALE_DOWN_MEMORY_THRESHOLD_PROD --body "25"
    gh variable set FARGATE_SPOT_WEIGHT_PROD --body "80"
    gh variable set FARGATE_WEIGHT_PROD --body "20"

    # ECS Service Configuration - Staging
    gh variable set CAPACITY_MIN_STAGING --body "1"
    gh variable set CAPACITY_MAX_STAGING --body "2"
    gh variable set CPU_STAGING --body "256"
    gh variable set MEMORY_STAGING --body "512"
    gh variable set SCALE_UP_CPU_THRESHOLD_STAGING --body "60"
    gh variable set SCALE_DOWN_CPU_THRESHOLD_STAGING --body "40"
    gh variable set SCALE_UP_MEMORY_THRESHOLD_STAGING --body "60"
    gh variable set SCALE_DOWN_MEMORY_THRESHOLD_STAGING --body "30"
    gh variable set FARGATE_SPOT_WEIGHT_STAGING --body "99"
    gh variable set FARGATE_WEIGHT_STAGING --body "1"

    # Release Configuration
    gh variable set RELEASE_NAME --body "GitHub Actions"
    gh variable set RELEASE_EMAIL --body "actions@github.com"

    # Feature Flags
    echo ""
    read -p "Maintenance mode for production (true/false) [false]: " MAINTENANCE_PROD
    MAINTENANCE_PROD=${MAINTENANCE_PROD:-"false"}
    read -p "Maintenance mode for staging (true/false) [false]: " MAINTENANCE_STAGING
    MAINTENANCE_STAGING=${MAINTENANCE_STAGING:-"false"}
    read -p "Cloudflare Turnstile site key (leave empty to disable): " TURNSTILE_KEY

    gh variable set MAINTENANCE_MODE_PROD --body "$MAINTENANCE_PROD"
    gh variable set MAINTENANCE_MODE_STAGING --body "$MAINTENANCE_STAGING"
    gh variable set TURNSTILE_SITE_KEY --body "$TURNSTILE_KEY"

    # SNS Alert Email
    read -p "SNS alert email (optional): " SNS_EMAIL
    gh variable set AWS_SNS_ALERT_EMAIL --body "$SNS_EMAIL"

    # DockerHub Configuration
    read -p "DockerHub username (optional): " DOCKERHUB_USER
    gh variable set DOCKERHUB_USERNAME --body "$DOCKERHUB_USER"

    echo ""
    echo "‚úÖ Full configuration completed!"
    echo ""
    echo "üìã Summary of configured variables:"
    echo "  üåê Domain: $DOMAIN_NAME"
    echo "  üì¶ Repository: $REPOSITORY_NAME"
    echo "  üê≥ ECR: $ECR_REPOSITORY"
    echo "  üîß Total variables configured: 40+"
    echo ""
}

# =============================================================================
# MAIN SCRIPT EXECUTION
# =============================================================================

function main() {
    check_prerequisites

    echo "This script will configure GitHub repository secrets and variables."
    echo ""

    # Show current repository
    local repo_info=$(gh repo view --json nameWithOwner --jq '.nameWithOwner' 2>/dev/null || echo "Unknown")
    echo "Repository: $repo_info"
    echo ""

    echo "Choose what to set up:"
    echo "1) Variables only - Minimum config (essential variables only)"
    echo "2) Variables only - Full config (all variables)"
    echo "3) Show secret commands (requires manual setup)"
    echo "4) Both variables (minimum) + secret commands"
    echo "5) Both variables (full) + secret commands"
    echo ""
    read -p "Enter your choice (1/2/3/4/5): " -n 1 -r
    echo ""

    case $REPLY in
        1)
            echo "Setting up minimum variables..."
            echo ""
            setup_minimum_config
            ;;
        2)
            echo "Setting up full variables..."
            echo ""
            setup_full_config
            ;;
        3)
            echo "Showing secret setup commands..."
            echo ""
            setup_secrets
            ;;
        4)
            echo "Setting up minimum variables and showing secret commands..."
            echo ""
            setup_minimum_config
            echo ""
            setup_secrets
            ;;
        5)
            echo "Setting up full variables and showing secret commands..."
            echo ""
            setup_full_config
            echo ""
            setup_secrets
            ;;
        *)
            echo "Invalid choice. Exiting."
            exit 1
            ;;
    esac

    echo ""
    echo "‚úÖ GitHub repository setup completed!"
    echo ""
    echo "üìã Verification commands:"
    echo "  gh variable list          # Show all variables"
    echo "  gh secret list           # Show all secrets (names only)"
    echo ""
    echo "üìã Test deployment:"
    echo "  gh workflow run staging.yml    # Manual staging deployment"
    echo "  gh workflow run prod.yml       # Manual production deployment"
    echo ""
    echo "‚ö†Ô∏è  Note: Many secrets may be inherited from the organization level."
    echo "    If deployment fails with auth errors, ensure secrets are set."
}

# Run main function if script is executed directly
if [[ "${BASH_SOURCE[0]}" == "${0}" ]]; then
    main "$@"
fi